'use client';
import useSWR from 'swr';
import api from '@/lib/api';
import { Badge } from '@/components/ui/badge';
import { useState, useEffect } from 'react';
import dynamic from 'next/dynamic';
import { Sparkles, CheckCircle2 } from 'lucide-react';
import { io } from 'socket.io-client';
import { toast } from 'sonner';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

const RemediationModal = dynamic(() => import('./RemediationModal'), { ssr: false });

const fetcher = (url: string) => api.get(url).then(res => res.data);

export function VulnerabilityFeed() {
    const { data: vulns, mutate } = useSWR('/vulnerabilities', fetcher);
    const [selectedVuln, setSelectedVuln] = useState<string | null>(null);

    useEffect(() => {
        const socket = io('http://localhost:4000');

        socket.on('connect', () => {
            console.log('Connected to real-time updates');
        });

        socket.on('vulnerabilities.updated', () => {
            toast.info('Risk assessment updated.');
            mutate();
        });

        return () => {
            socket.disconnect();
        };
    }, [mutate]);

    if (!vulns || vulns.length === 0) return <div className="text-gray-500 text-sm">No vulnerabilities detected. Good job!</div>;

    return (
        <>
            <div className="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                {vulns.map((v: any) => (
                    <div key={v.id} className={`flex flex-col gap-3 p-4 border rounded-lg transition-all ${v.status === 'RESOLVED' ? 'bg-green-50 border-green-200 opacity-75' : 'bg-white border-gray-200 dark:bg-gray-800 dark:border-gray-700'}`}>
                        <div className="flex justify-between items-start">
                            <div>
                                <h4 className="font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                    {v.title}
                                    {v.status === 'RESOLVED' && <CheckCircle2 size={16} className="text-green-600" />}
                                </h4>
                                <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{v.description}</p>
                                <p className="text-xs text-gray-500 mt-2 font-mono">ID: {v.asset?.cloudId}</p>
                            </div>
                            <Badge variant={v.status === 'RESOLVED' ? 'outline' : (v.severity === 'HIGH' ? 'destructive' : 'secondary')}>
                                {v.status === 'RESOLVED' ? 'RESOLVED' : v.severity}
                            </Badge>
                        </div>

                        {v.status !== 'RESOLVED' && (
                            <button
                                onClick={() => setSelectedVuln(v.id)}
                                className="self-start text-xs flex items-center gap-1.5 bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-full hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-300 dark:hover:bg-indigo-900/50 transition-colors font-medium"
                            >
                                <Sparkles size={14} />
                                Fix with AI
                            </button>
                        )}
                    </div>
                ))}
            </div>

            {selectedVuln && (
                <RemediationModal
                    isOpen={!!selectedVuln}
                    onClose={() => setSelectedVuln(null)}
                    vulnerabilityId={selectedVuln}
                    onSuccess={() => mutate()}
                />
            )}
        </>
    );
}
